<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="FretLog - View your practice statistics and progress over time">
    <title>Statistics - FretLog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/css/styles.css">
    <script>
        (function () {
            const savedTheme = localStorage.getItem('fretlog-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Year selector */
        .year-selector {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: var(--font-weight-semibold);
        }

        .year-selector button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Additional styles for heatmap */
        .heatmap-wrapper {
            display: flex;
            gap: 8px;
        }

        .heatmap-labels {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: var(--font-size-caption);
            color: var(--text-secondary);
            width: 30px;
            flex-shrink: 0;
        }

        .heatmap-labels span {
            height: 0;
            flex: 1;
            display: flex;
            align-items: center;
        }

        .heatmap-months {
            margin-bottom: 8px;
            padding-left: 38px;
        }

        .heatmap-months-inner {
            display: flex;
            gap: 2px;
            width: 100%;
        }

        .heatmap-months span,
        .heatmap-months-inner span {
            font-size: var(--font-size-caption);
            color: var(--text-secondary);
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: var(--spacing-sm);
            font-size: var(--font-size-caption);
            color: var(--text-secondary);
        }

        .heatmap-legend .heatmap-day {
            cursor: default;
            width: 12px;
            height: 12px;
            flex: none;
        }

        .heatmap-day {
            transition: transform 0.1s ease;
        }

        .heatmap-day.faded {
            opacity: 0.3;
        }

        .heatmap-day:hover {
            transform: scale(1.5);
        }

        .heatmap-tooltip {
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 4px 8px;
            font-size: var(--font-size-caption);
            pointer-events: none;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="main-header">
            <div class="header-left">
                <a href="index.html" class="logo">
                    <svg class="logo-icon" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="16" cy="16" r="14" fill="#2E3A8C" />
                        <path d="M11 22V10L14 10V22H11Z" fill="white" />
                        <circle cx="11.5" cy="23.5" r="2.5" fill="white" />
                        <path d="M18 22V10L21 10V22H18Z" fill="white" />
                        <circle cx="18.5" cy="23.5" r="2.5" fill="white" />
                        <path d="M14 11H21V13H14V11Z" fill="white" />
                    </svg>
                    <span>FretLog</span>
                </a>
                <nav class="main-nav">
                    <a href="index.html" class="nav-link" data-page="dashboard">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="3" width="7" height="7" rx="1" />
                            <rect x="14" y="3" width="7" height="7" rx="1" />
                            <rect x="3" y="14" width="7" height="7" rx="1" />
                            <rect x="14" y="14" width="7" height="7" rx="1" />
                        </svg>
                        Dashboard
                    </a>
                    <a href="sessions.html" class="nav-link" data-page="sessions">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                        </svg>
                        Sessions
                    </a>
                    <a href="library.html" class="nav-link" data-page="library">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                        </svg>
                        Library
                    </a>
                    <a href="statistics.html" class="nav-link active" data-page="statistics">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10" />
                            <line x1="12" y1="20" x2="12" y2="4" />
                            <line x1="6" y1="20" x2="6" y2="14" />
                        </svg>
                        Statistics
                    </a>
                </nav>
            </div>
            <div class="header-right">
                <div id="global-active-item-info" class="flex flex-col items-end hidden"
                    style="margin-right: 12px; justify-content: center;">
                    <span id="global-active-item-name" class="text-secondary font-semibold"
                        style="font-size: 0.85rem; line-height: 1.2;"></span>
                    <span id="global-active-item-timer" class="text-primary font-bold"
                        style="font-size: 0.8rem; line-height: 1.2;">00:00</span>
                </div>
                <button class="icon-btn hidden" id="global-pause-btn" title="Pause Active Timer"
                    onclick="toggleGlobalTimer()"
                    style="color: var(--color-primary); background: rgba(74, 95, 217, 0.1);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                </button>
                <button class="icon-btn" id="theme-toggle" title="Toggle theme">
                    <span class="theme-icon">ðŸŒ™</span>
                </button>
                <a href="settings.html" class="icon-btn" title="Settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3" />
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                    </svg>
                </a>
                <div class="user-profile dropdown" id="user-dropdown">
                    <div class="user-avatar" id="user-avatar">M</div>
                    <div class="user-info">
                        <span class="user-name" id="user-name">Musician</span>
                        <span class="user-instrument" id="user-instrument">Guitar</span>
                    </div>
                    <div class="dropdown-menu">
                        <div class="dropdown-item" id="change-instrument-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                            </svg>
                            Change Instrument
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <script>
            (function () {
                try {
                    const user = JSON.parse(localStorage.getItem('fretlog_user_cache'));
                    if (user) {
                        document.getElementById('user-name').textContent = user.name || 'Musician';
                        document.getElementById('user-avatar').textContent = (user.name || 'M').charAt(0).toUpperCase();

                        const instruments = JSON.parse(localStorage.getItem('fretlog_instruments_cache') || '[]');
                        if (instruments.length && user.defaultInstrumentId) {
                            const inst = instruments.find(i => i.id === user.defaultInstrumentId);
                            if (inst) document.getElementById('user-instrument').textContent = inst.name;
                        }
                    }
                } catch (e) { console.warn('Preload error', e); }
            })();
        </script>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Statistics</h1>
                    <p class="text-secondary mt-sm">Track your practice progress and trends</p>
                </div>
            </div>

            <!-- Summary Cards -->
            <div>
                <h3 class="card-title mb-md">Overview</h3>
                <div class="grid grid-4 mb-lg">
                    <div class="card stat-card" style="padding: var(--spacing-md);">
                        <span class="stat-value" id="total-time">0h</span>
                        <span class="stat-label">Total Practice Time</span>
                    </div>
                    <div class="card stat-card" style="padding: var(--spacing-md);">
                        <span class="stat-value" id="total-sessions">0</span>
                        <span class="stat-label">Total Sessions</span>
                    </div>
                    <div class="card stat-card" style="padding: var(--spacing-md);">
                        <span class="stat-value" id="avg-session">0m</span>
                        <span class="stat-label">Avg. Session Length</span>
                    </div>
                    <div class="card stat-card" style="padding: var(--spacing-md);">
                        <span class="stat-value" id="streak-days">0 days</span>
                        <span class="stat-label">Practice Streak</span>
                    </div>
                </div>
            </div>

            <!-- Practice Trends Chart -->
            <div>
                <h3 class="card-title mb-md">Practice Trends</h3>
                <div class="card mb-lg">
                    <div class="card-header">
                        <div class="period-selector" id="trends-period">
                            <button class="period-btn active" data-period="week">Week</button>
                            <button class="period-btn" data-period="month">Month</button>
                            <button class="period-btn" data-period="year">Year</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trends-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- GitHub-style Heatmap -->
            <div>
                <h3 class="card-title mb-md">Practice Activity</h3>
                <div class="card mb-lg">
                    <div class="card-header" style="justify-content: flex-end;">
                        <div class="year-selector" id="year-selector"
                            style="display: flex; align-items: center; gap: var(--spacing-sm);">
                            <button class="btn btn-ghost btn-sm" id="prev-year">&lt;</button>
                            <span id="heatmap-year" style="font-weight: var(--font-weight-semibold);">2026</span>
                            <button class="btn btn-ghost btn-sm" id="next-year">&gt;</button>
                        </div>
                    </div>
                    <div class="heatmap-container" id="heatmap-container">
                        <div class="heatmap-months" id="heatmap-months"></div>
                        <div class="heatmap-wrapper">
                            <div class="heatmap-labels" id="heatmap-labels">
                                <!-- Generated dynamically -->
                            </div>
                            <div class="heatmap" id="heatmap"></div>
                        </div>
                        <div class="heatmap-legend">
                            <span>Less</span>
                            <div class="heatmap-day level-0"></div>
                            <div class="heatmap-day level-1"></div>
                            <div class="heatmap-day level-2"></div>
                            <div class="heatmap-day level-3"></div>
                            <div class="heatmap-day level-4"></div>
                            <div class="heatmap-day level-5"></div>
                            <div class="heatmap-day level-6"></div>
                            <div class="heatmap-day level-7"></div>
                            <div class="heatmap-day level-8"></div>
                            <div class="heatmap-day level-9"></div>
                            <div class="heatmap-day level-10"></div>
                            <span>More</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-2 gap-lg">
                <!-- Category Breakdown -->
                <div>
                    <h3 class="card-title mb-md">Category Breakdown</h3>
                    <div class="card">
                        <div class="card-header">
                            <div class="period-selector" id="category-period">
                                <button class="period-btn" data-period="week">Week</button>
                                <button class="period-btn active" data-period="month">Month</button>
                                <button class="period-btn" data-period="year">Year</button>
                                <button class="period-btn" data-period="alltime">All Time</button>
                            </div>
                        </div>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="category-chart"></canvas>
                        </div>
                        <div id="category-list" class="mt-lg">
                            <!-- Dynamic list -->
                        </div>
                    </div>
                </div>

                <!-- Top Practiced Items -->
                <div>
                    <h3 class="card-title mb-md">Top Practiced Items</h3>
                    <div class="card">
                        <div class="card-header">
                            <div class="period-selector" id="top-items-period">
                                <button class="period-btn" data-period="week">Week</button>
                                <button class="period-btn active" data-period="month">Month</button>
                                <button class="period-btn" data-period="year">Year</button>
                                <button class="period-btn" data-period="alltime">All Time</button>
                            </div>
                        </div>
                        <ul class="practice-list" id="top-items-list"
                            style="margin-top: var(--spacing-md); margin-bottom: calc(-1 * var(--spacing-md));">
                            <!-- Dynamic content -->
                        </ul>
                        <div class="empty-state hidden" id="no-top-items" style="padding: var(--spacing-lg);">
                            <p class="text-secondary">No practice data for this period</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Change Instrument Modal -->
    <div class="modal-overlay" id="change-instrument-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Select Instrument</h3>
                <button class="modal-close" onclick="closeModal('change-instrument-modal')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Instrument</label>
                    <select class="form-select" id="select-instrument">
                        <!-- Populated dynamically -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('change-instrument-modal')">Cancel</button>
                <button class="btn btn-primary" id="confirm-instrument">Select</button>
            </div>
        </div>
    </div>

    <script src="static/js/data.js"></script>
    <script src="static/js/timer.js"></script>
    <script src="static/js/theme.js"></script>
    <script>
        // ==========================================
        // Statistics Page Logic
        // ==========================================

        let trendsChart = null;
        let categoryChart = null;

        // Utility Functions
        function formatTimeHuman(ms) {
            const totalMinutes = Math.floor(ms / 60000);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            if (hours > 0) return `${hours}h ${minutes}m`;
            return `${minutes}m`;
        }

        function formatHours(ms) {
            const hours = ms / (1000 * 60 * 60);
            return hours.toFixed(1);
        }

        // Update user info
        function updateUserInfo() {
            const user = FretLogData.getUser();
            const instrument = FretLogData.getCurrentInstrument();
            document.getElementById('user-name').textContent = user?.name || 'Musician';
            document.getElementById('user-instrument').textContent = instrument?.name || 'Guitar';
            document.getElementById('user-avatar').textContent = (user?.name || 'M').charAt(0).toUpperCase();
        }

        // Update summary cards
        function updateSummaryCards() {
            const sessions = FretLogData.getSessions();
            const totalTime = sessions.reduce((sum, s) => sum + (s.totalTime || 0), 0);

            document.getElementById('total-time').textContent = formatTimeHuman(totalTime);
            document.getElementById('total-sessions').textContent = sessions.length;

            if (sessions.length > 0) {
                const avgTime = totalTime / sessions.length;
                document.getElementById('avg-session').textContent = formatTimeHuman(avgTime);
            }

            // Calculate streak
            const dailyTotals = FretLogData.getDailyTotals();
            let streak = 0;
            const today = new Date();

            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateKey = checkDate.toISOString().split('T')[0];

                if (dailyTotals[dateKey] && dailyTotals[dateKey] > 0) {
                    streak++;
                } else if (i > 0) {
                    break;
                }
            }

            document.getElementById('streak-days').textContent = `${streak} days`;
        }

        // Practice Trends Chart
        function renderTrendsChart(period = 'week') {
            const ctx = document.getElementById('trends-chart').getContext('2d');

            // Get date range based on period
            const now = new Date();
            let labels = [];
            let data = [];
            let startDate = new Date();

            const dailyTotals = FretLogData.getDailyTotals();

            switch (period) {
                case 'week':
                    // Monday-to-Sunday fixed week
                    const weekStart = new Date(now);
                    const day = now.getDay();
                    const diff = (day === 0 ? 6 : day - 1);
                    weekStart.setDate(now.getDate() - diff);
                    weekStart.setHours(0, 0, 0, 0);

                    for (let i = 0; i < 7; i++) {
                        const date = new Date(weekStart);
                        date.setDate(weekStart.getDate() + i);
                        const dateKey = date.toISOString().split('T')[0];
                        labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                        data.push((dailyTotals[dateKey] || 0) / 60000); // Convert to minutes
                    }
                    break;
                case 'month':
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date(now);
                        date.setDate(now.getDate() - i);
                        const dateKey = date.toISOString().split('T')[0];
                        labels.push(date.getDate().toString());
                        data.push((dailyTotals[dateKey] || 0) / 60000);
                    }
                    break;
                case 'year':
                    // Group by week
                    for (let i = 51; i >= 0; i--) {
                        const weekStart = new Date(now);
                        weekStart.setDate(now.getDate() - (i * 7));
                        let weekTotal = 0;
                        for (let j = 0; j < 7; j++) {
                            const date = new Date(weekStart);
                            date.setDate(weekStart.getDate() + j);
                            const dateKey = date.toISOString().split('T')[0];
                            weekTotal += dailyTotals[dateKey] || 0;
                        }
                        labels.push(`W${52 - i}`);
                        data.push(weekTotal / 60000);
                    }
                    break;
                case 'alltime':
                    // Group by month for all recorded data
                    const monthlyTotals = {};
                    Object.entries(dailyTotals).forEach(([dateKey, time]) => {
                        const monthKey = dateKey.substring(0, 7); // YYYY-MM format
                        monthlyTotals[monthKey] = (monthlyTotals[monthKey] || 0) + time;
                    });
                    const sortedMonths = Object.keys(monthlyTotals).sort();
                    sortedMonths.forEach(monthKey => {
                        const date = new Date(monthKey + '-01');
                        labels.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
                        data.push(monthlyTotals[monthKey] / 60000);
                    });
                    break;
            }

            if (trendsChart) {
                trendsChart.destroy();
            }

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDark ? '#9CA3AF' : '#4A4A4A';

            // Create gradients for a "Practice Intensity" look
            const lineGradient = ctx.createLinearGradient(0, 0, 0, 300);
            lineGradient.addColorStop(0, '#8b5cf6');   // High Intensity (Violet)
            lineGradient.addColorStop(0.5, '#4f46e5'); // Medium Intensity (Indigo)
            lineGradient.addColorStop(1, '#2E3A8C');   // Base Intensity (Deep Blue)

            const fillGradient = ctx.createLinearGradient(0, 0, 0, 300);
            fillGradient.addColorStop(0, 'rgba(139, 92, 246, 0.4)'); // High
            fillGradient.addColorStop(0.5, 'rgba(79, 70, 229, 0.2)'); // Mid
            fillGradient.addColorStop(1, 'rgba(46, 58, 140, 0)');     // Base (Transparent)

            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Practice Time (minutes)',
                        data,
                        borderColor: lineGradient,
                        borderWidth: 3,
                        backgroundColor: fillGradient,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: lineGradient,
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${Math.round(context.raw)} minutes`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: textColor,
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: period === 'year' ? 12 : (period === 'month' ? 10 : 7)
                            }
                        }
                    }
                }
            });
        }

        // GitHub-style Heatmap
        let heatmapYear = new Date().getFullYear();

        function renderHeatmap(year = heatmapYear) {
            heatmapYear = year;
            const container = document.getElementById('heatmap');
            const monthsContainer = document.getElementById('heatmap-months');
            const labelsContainer = document.getElementById('heatmap-labels');
            const yearDisplay = document.getElementById('heatmap-year');
            const dailyTotals = FretLogData.getDailyTotals();

            // Update year display
            yearDisplay.textContent = year;

            // Disable next button if viewing current year
            const currentYear = new Date().getFullYear();
            document.getElementById('next-year').disabled = year >= currentYear;

            // Get max value for scaling (from this year's data)
            const yearData = Object.entries(dailyTotals)
                .filter(([date]) => date.startsWith(year.toString()))
                .map(([, value]) => value);
            const maxValue = Math.max(...yearData, 1);

            // Generate weeks for the full calendar year (Jan 1 - Dec 31)
            // Using Monday as first day of week (ISO standard)
            const startDate = new Date(year, 0, 1); // Jan 1
            const endDate = new Date(year, 11, 31); // Dec 31

            // Find the first Monday on or before Jan 1
            const firstDay = new Date(startDate);
            const dayOfWeek = firstDay.getDay();
            // Convert Sunday=0 to 7 for easier Monday-based calculation
            const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            firstDay.setDate(firstDay.getDate() - daysToSubtract);

            // Find the last Sunday on or after Dec 31
            const lastDay = new Date(endDate);
            const endDayOfWeek = lastDay.getDay();
            if (endDayOfWeek !== 0) {
                lastDay.setDate(lastDay.getDate() + (7 - endDayOfWeek));
            }

            const weeks = [];
            const monthPositions = []; // Track which week each month starts
            let currentDate = new Date(firstDay);
            let weekIndex = 0;
            let lastMonth = -1;

            while (currentDate <= lastDay) {
                const weekData = [];
                for (let day = 0; day < 7; day++) {
                    // Use local date format to avoid timezone issues
                    const dateKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                    const value = dailyTotals[dateKey] || 0;
                    const level = value === 0 ? 0 : Math.ceil((value / maxValue) * 10);
                    const isCurrentYear = currentDate.getFullYear() === year;

                    // Track month positions (when month changes on Monday)
                    if (day === 0 && isCurrentYear && currentDate.getMonth() !== lastMonth) {
                        monthPositions.push({
                            month: currentDate.toLocaleDateString('en-US', { month: 'short' }),
                            weekIndex: weekIndex
                        });
                        lastMonth = currentDate.getMonth();
                    }

                    weekData.push({
                        date: dateKey,
                        value,
                        level: isCurrentYear ? Math.min(level, 10) : 0,
                        displayDate: currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                        isCurrentYear
                    });

                    currentDate.setDate(currentDate.getDate() + 1);
                }
                weeks.push(weekData);
                weekIndex++;
            }

            // Render weekday labels (Mon-Sun: M T W T F S S)
            labelsContainer.innerHTML = `
                <span>M</span>
                <span>T</span>
                <span>W</span>
                <span>T</span>
                <span>F</span>
                <span>S</span>
                <span>S</span>
            `;

            // Render month labels with proper positioning
            const totalWeeks = weeks.length;
            let monthsHTML = '<div class="heatmap-months-inner">';
            monthPositions.forEach((pos, i) => {
                const nextPos = monthPositions[i + 1];
                const span = nextPos ? nextPos.weekIndex - pos.weekIndex : totalWeeks - pos.weekIndex;
                monthsHTML += `<span style="flex: ${span};">${pos.month}</span>`;
            });
            monthsHTML += '</div>';
            monthsContainer.innerHTML = monthsHTML;

            // Render heatmap
            container.innerHTML = weeks.map(week => `
                <div class="heatmap-week">
                    ${week.map(day => `
                        <div class="heatmap-day level-${day.level}${!day.isCurrentYear ? ' faded' : ''}" 
                             data-date="${day.displayDate}" 
                             data-value="${formatTimeHuman(day.value)}"
                             title="${day.displayDate}: ${formatTimeHuman(day.value)}">
                        </div>
                    `).join('')}
                </div>
            `).join('');

            // Add hover tooltips
            container.querySelectorAll('.heatmap-day').forEach(day => {
                day.addEventListener('mouseenter', (e) => {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'heatmap-tooltip';
                    tooltip.textContent = `${e.target.dataset.value} on ${e.target.dataset.date}`;
                    tooltip.style.left = `${e.pageX + 10}px`;
                    tooltip.style.top = `${e.pageY - 30}px`;
                    tooltip.id = 'heatmap-tooltip';
                    document.body.appendChild(tooltip);
                });
                day.addEventListener('mouseleave', () => {
                    document.getElementById('heatmap-tooltip')?.remove();
                });
            });
        }

        // Category Breakdown Chart
        function renderCategoryChart(period = 'month') {
            const ctx = document.getElementById('category-chart').getContext('2d');
            const breakdown = FretLogData.getCategoryBreakdown(period);

            if (categoryChart) {
                categoryChart.destroy();
            }

            const totalTime = breakdown.reduce((sum, c) => sum + c.totalTime, 0);

            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: breakdown.map(c => c.name),
                    datasets: [{
                        data: breakdown.map(c => c.totalTime / 60000),
                        backgroundColor: breakdown.map(c => c.color || '#2E3A8C'),
                        borderWidth: 2,
                        borderColor: isDark ? '#1E2231' : '#FFFFFF'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: isDark ? '#9CA3AF' : '#4A4A4A',
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const minutes = Math.round(context.raw);
                                    const percent = totalTime > 0 ? Math.round((context.raw * 60000 / totalTime) * 100) : 0;
                                    return `${minutes} min (${percent}%)`;
                                }
                            }
                        }
                    },
                    cutout: '65%'
                }
            });

            // Render category list
            const listContainer = document.getElementById('category-list');
            listContainer.innerHTML = breakdown.length ? breakdown.map((cat, i) => {
                const percent = totalTime > 0 ? Math.round((cat.totalTime / totalTime) * 100) : 0;
                return `
          <div class="practice-item">
            <div class="practice-item-info">
              <span class="practice-item-name">
                <span style="display: inline-block; width: 12px; height: 12px; background: ${cat.color || '#2E3A8C'}; border-radius: 2px; margin-right: 8px;"></span>
                ${cat.icon} ${cat.name}
              </span>
            </div>
            <span class="practice-item-time">${formatTimeHuman(cat.totalTime)} (${percent}%)</span>
          </div>
        `;
            }).join('') : '<p class="text-center text-secondary" style="padding: var(--spacing-md);">No data for this period</p>';
        }

        // Top Practiced Items
        function renderTopItems(period = 'month') {
            const items = FretLogData.getMostPracticedItems(period, 10);
            const listEl = document.getElementById('top-items-list');
            const emptyEl = document.getElementById('no-top-items');

            if (items.length === 0) {
                listEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                return;
            }

            listEl.classList.remove('hidden');
            emptyEl.classList.add('hidden');

            const categories = FretLogData.getCategories();
            const libraryItems = FretLogData.getLibraryItems();

            listEl.innerHTML = items.map((item, index) => {
                const libraryItem = libraryItems.find(li => li.id === item.id);
                const category = categories.find(c => c.id === (libraryItem?.categoryId || libraryItem?.category_id));
                const categoryBadge = category ?
                    `<span class="badge" style="background-color: ${category.color}1a; color: ${category.color}; border: 1px solid ${category.color}33; margin-left: 8px;">${category.icon} ${category.name}</span>` :
                    '';

                return `
                <li class="practice-item">
                    <div class="practice-item-info">
                        <span class="practice-item-name">
                            <span class="text-secondary" style="margin-right: 8px;">#${index + 1}</span>
                            ${item.name}
                            ${categoryBadge}
                        </span>
                    </div>
                    <span class="practice-item-time">${formatTimeHuman(item.totalTime)}</span>
                </li>
                `;
            }).join('');
        }

        // Initialize all charts and data
        function initStats() {
            updateSummaryCards();
            renderTrendsChart('week');
            renderHeatmap();
            renderCategoryChart('month');
            renderTopItems('month');
        }

        // Event Listeners
        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            async function renderPage() {
                updateUserInfo();
                initStats();
            }

            // 1. Kick off init
            const initPromise = FretLogData.init();

            // 2. Render cached data
            await renderPage();

            // 3. Wait for fresh data
            await initPromise;

            // 4. Render fresh data
            await renderPage();

            // Trends period selector
            document.querySelectorAll('#trends-period .period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#trends-period .period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderTrendsChart(btn.dataset.period);
                });
            });

            // Category period selector
            document.querySelectorAll('#category-period .period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#category-period .period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderCategoryChart(btn.dataset.period);
                });
            });

            // Top items period selector
            document.querySelectorAll('#top-items-period .period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#top-items-period .period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderTopItems(btn.dataset.period);
                });
            });

            // Year selector for heatmap
            document.getElementById('prev-year').addEventListener('click', () => {
                renderHeatmap(heatmapYear - 1);
            });
            document.getElementById('next-year').addEventListener('click', () => {
                if (heatmapYear < new Date().getFullYear()) {
                    renderHeatmap(heatmapYear + 1);
                }
            });

            // Re-render charts on theme change
            const themeToggle = document.getElementById('theme-toggle');
            const originalClick = themeToggle.onclick;
            themeToggle.addEventListener('click', () => {
                setTimeout(() => {
                    renderTrendsChart(document.querySelector('#trends-period .period-btn.active')?.dataset.period || 'week');
                    renderCategoryChart(document.querySelector('#category-period .period-btn.active')?.dataset.period || 'month');
                }, 100);
            });
        });
    </script>
    <script src="static/js/app.js"></script>
</body>

</html>